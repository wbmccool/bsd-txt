(function(){function n(n){function t(t,e,r,i,a,o){for(;a>=0&&o>a;a+=n){var u=i?i[a]:a;r=e(r,t[u],u,t)}return r}return function(e,r,i,a){r=y(r,a,4);var o=!k(e)&&m.keys(e),u=(o||e).length,l=n>0?0:u-1;return arguments.length<3&&(i=e[o?o[l]:l],l+=n),t(e,r,i,o,l,u)}}function t(n){return function(t,e,r){e=w(e,r);for(var i=null!=t&&t.length,a=n>0?0:i-1;a>=0&&i>a;a+=n)if(e(t[a],a,t))return a;return-1}}function e(n,t){var e=I.length,r=n.constructor,i=m.isFunction(r)&&r.prototype||o,a="constructor";for(m.has(n,a)&&!m.contains(t,a)&&t.push(a);e--;)a=I[e],a in n&&n[a]!==i[a]&&!m.contains(t,a)&&t.push(a)}var r=this,i=r._,a=Array.prototype,o=Object.prototype,u=Function.prototype,l=a.push,c=a.slice,s=o.toString,f=o.hasOwnProperty,h=Array.isArray,p=Object.keys,g=u.bind,d=Object.create,v=function(){},m=function(n){return n instanceof m?n:this instanceof m?void(this._wrapped=n):new m(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=m),exports._=m):r._=m,m.VERSION="1.8.2";var y=function(n,t,e){if(void 0===t)return n;switch(null==e?3:e){case 1:return function(e){return n.call(t,e)};case 2:return function(e,r){return n.call(t,e,r)};case 3:return function(e,r,i){return n.call(t,e,r,i)};case 4:return function(e,r,i,a){return n.call(t,e,r,i,a)}}return function(){return n.apply(t,arguments)}},w=function(n,t,e){return null==n?m.identity:m.isFunction(n)?y(n,t,e):m.isObject(n)?m.matcher(n):m.property(n)};m.iteratee=function(n,t){return w(n,t,1/0)};var x=function(n,t){return function(e){var r=arguments.length;if(2>r||null==e)return e;for(var i=1;r>i;i++)for(var a=arguments[i],o=n(a),u=o.length,l=0;u>l;l++){var c=o[l];t&&void 0!==e[c]||(e[c]=a[c])}return e}},b=function(n){if(!m.isObject(n))return{};if(d)return d(n);v.prototype=n;var t=new v;return v.prototype=null,t},_=Math.pow(2,53)-1,k=function(n){var t=n&&n.length;return"number"==typeof t&&t>=0&&_>=t};m.each=m.forEach=function(n,t,e){t=y(t,e);var r,i;if(k(n))for(r=0,i=n.length;i>r;r++)t(n[r],r,n);else{var a=m.keys(n);for(r=0,i=a.length;i>r;r++)t(n[a[r]],a[r],n)}return n},m.map=m.collect=function(n,t,e){t=w(t,e);for(var r=!k(n)&&m.keys(n),i=(r||n).length,a=Array(i),o=0;i>o;o++){var u=r?r[o]:o;a[o]=t(n[u],u,n)}return a},m.reduce=m.foldl=m.inject=n(1),m.reduceRight=m.foldr=n(-1),m.find=m.detect=function(n,t,e){var r;return r=k(n)?m.findIndex(n,t,e):m.findKey(n,t,e),void 0!==r&&-1!==r?n[r]:void 0},m.filter=m.select=function(n,t,e){var r=[];return t=w(t,e),m.each(n,function(n,e,i){t(n,e,i)&&r.push(n)}),r},m.reject=function(n,t,e){return m.filter(n,m.negate(w(t)),e)},m.every=m.all=function(n,t,e){t=w(t,e);for(var r=!k(n)&&m.keys(n),i=(r||n).length,a=0;i>a;a++){var o=r?r[a]:a;if(!t(n[o],o,n))return!1}return!0},m.some=m.any=function(n,t,e){t=w(t,e);for(var r=!k(n)&&m.keys(n),i=(r||n).length,a=0;i>a;a++){var o=r?r[a]:a;if(t(n[o],o,n))return!0}return!1},m.contains=m.includes=m.include=function(n,t,e){return k(n)||(n=m.values(n)),m.indexOf(n,t,"number"==typeof e&&e)>=0},m.invoke=function(n,t){var e=c.call(arguments,2),r=m.isFunction(t);return m.map(n,function(n){var i=r?t:n[t];return null==i?i:i.apply(n,e)})},m.pluck=function(n,t){return m.map(n,m.property(t))},m.where=function(n,t){return m.filter(n,m.matcher(t))},m.findWhere=function(n,t){return m.find(n,m.matcher(t))},m.max=function(n,t,e){var r,i,a=-1/0,o=-1/0;if(null==t&&null!=n){n=k(n)?n:m.values(n);for(var u=0,l=n.length;l>u;u++)r=n[u],r>a&&(a=r)}else t=w(t,e),m.each(n,function(n,e,r){i=t(n,e,r),(i>o||i===-1/0&&a===-1/0)&&(a=n,o=i)});return a},m.min=function(n,t,e){var r,i,a=1/0,o=1/0;if(null==t&&null!=n){n=k(n)?n:m.values(n);for(var u=0,l=n.length;l>u;u++)r=n[u],a>r&&(a=r)}else t=w(t,e),m.each(n,function(n,e,r){i=t(n,e,r),(o>i||1/0===i&&1/0===a)&&(a=n,o=i)});return a},m.shuffle=function(n){for(var t,e=k(n)?n:m.values(n),r=e.length,i=Array(r),a=0;r>a;a++)t=m.random(0,a),t!==a&&(i[a]=i[t]),i[t]=e[a];return i},m.sample=function(n,t,e){return null==t||e?(k(n)||(n=m.values(n)),n[m.random(n.length-1)]):m.shuffle(n).slice(0,Math.max(0,t))},m.sortBy=function(n,t,e){return t=w(t,e),m.pluck(m.map(n,function(n,e,r){return{value:n,index:e,criteria:t(n,e,r)}}).sort(function(n,t){var e=n.criteria,r=t.criteria;if(e!==r){if(e>r||void 0===e)return 1;if(r>e||void 0===r)return-1}return n.index-t.index}),"value")};var j=function(n){return function(t,e,r){var i={};return e=w(e,r),m.each(t,function(r,a){var o=e(r,a,t);n(i,r,o)}),i}};m.groupBy=j(function(n,t,e){m.has(n,e)?n[e].push(t):n[e]=[t]}),m.indexBy=j(function(n,t,e){n[e]=t}),m.countBy=j(function(n,t,e){m.has(n,e)?n[e]++:n[e]=1}),m.toArray=function(n){return n?m.isArray(n)?c.call(n):k(n)?m.map(n,m.identity):m.values(n):[]},m.size=function(n){return null==n?0:k(n)?n.length:m.keys(n).length},m.partition=function(n,t,e){t=w(t,e);var r=[],i=[];return m.each(n,function(n,e,a){(t(n,e,a)?r:i).push(n)}),[r,i]},m.first=m.head=m.take=function(n,t,e){return null==n?void 0:null==t||e?n[0]:m.initial(n,n.length-t)},m.initial=function(n,t,e){return c.call(n,0,Math.max(0,n.length-(null==t||e?1:t)))},m.last=function(n,t,e){return null==n?void 0:null==t||e?n[n.length-1]:m.rest(n,Math.max(0,n.length-t))},m.rest=m.tail=m.drop=function(n,t,e){return c.call(n,null==t||e?1:t)},m.compact=function(n){return m.filter(n,m.identity)};var O=function(n,t,e,r){for(var i=[],a=0,o=r||0,u=n&&n.length;u>o;o++){var l=n[o];if(k(l)&&(m.isArray(l)||m.isArguments(l))){t||(l=O(l,t,e));var c=0,s=l.length;for(i.length+=s;s>c;)i[a++]=l[c++]}else e||(i[a++]=l)}return i};m.flatten=function(n,t){return O(n,t,!1)},m.without=function(n){return m.difference(n,c.call(arguments,1))},m.uniq=m.unique=function(n,t,e,r){if(null==n)return[];m.isBoolean(t)||(r=e,e=t,t=!1),null!=e&&(e=w(e,r));for(var i=[],a=[],o=0,u=n.length;u>o;o++){var l=n[o],c=e?e(l,o,n):l;t?(o&&a===c||i.push(l),a=c):e?m.contains(a,c)||(a.push(c),i.push(l)):m.contains(i,l)||i.push(l)}return i},m.union=function(){return m.uniq(O(arguments,!0,!0))},m.intersection=function(n){if(null==n)return[];for(var t=[],e=arguments.length,r=0,i=n.length;i>r;r++){var a=n[r];if(!m.contains(t,a)){for(var o=1;e>o&&m.contains(arguments[o],a);o++);o===e&&t.push(a)}}return t},m.difference=function(n){var t=O(arguments,!0,!0,1);return m.filter(n,function(n){return!m.contains(t,n)})},m.zip=function(){return m.unzip(arguments)},m.unzip=function(n){for(var t=n&&m.max(n,"length").length||0,e=Array(t),r=0;t>r;r++)e[r]=m.pluck(n,r);return e},m.object=function(n,t){for(var e={},r=0,i=n&&n.length;i>r;r++)t?e[n[r]]=t[r]:e[n[r][0]]=n[r][1];return e},m.indexOf=function(n,t,e){var r=0,i=n&&n.length;if("number"==typeof e)r=0>e?Math.max(0,i+e):e;else if(e&&i)return r=m.sortedIndex(n,t),n[r]===t?r:-1;if(t!==t)return m.findIndex(c.call(n,r),m.isNaN);for(;i>r;r++)if(n[r]===t)return r;return-1},m.lastIndexOf=function(n,t,e){var r=n?n.length:0;if("number"==typeof e&&(r=0>e?r+e+1:Math.min(r,e+1)),t!==t)return m.findLastIndex(c.call(n,0,r),m.isNaN);for(;--r>=0;)if(n[r]===t)return r;return-1},m.findIndex=t(1),m.findLastIndex=t(-1),m.sortedIndex=function(n,t,e,r){e=w(e,r,1);for(var i=e(t),a=0,o=n.length;o>a;){var u=Math.floor((a+o)/2);e(n[u])<i?a=u+1:o=u}return a},m.range=function(n,t,e){arguments.length<=1&&(t=n||0,n=0),e=e||1;for(var r=Math.max(Math.ceil((t-n)/e),0),i=Array(r),a=0;r>a;a++,n+=e)i[a]=n;return i};var A=function(n,t,e,r,i){if(!(r instanceof t))return n.apply(e,i);var a=b(n.prototype),o=n.apply(a,i);return m.isObject(o)?o:a};m.bind=function(n,t){if(g&&n.bind===g)return g.apply(n,c.call(arguments,1));if(!m.isFunction(n))throw new TypeError("Bind must be called on a function");var e=c.call(arguments,2),r=function(){return A(n,r,t,this,e.concat(c.call(arguments)))};return r},m.partial=function(n){var t=c.call(arguments,1),e=function(){for(var r=0,i=t.length,a=Array(i),o=0;i>o;o++)a[o]=t[o]===m?arguments[r++]:t[o];for(;r<arguments.length;)a.push(arguments[r++]);return A(n,e,this,this,a)};return e},m.bindAll=function(n){var t,e,r=arguments.length;if(1>=r)throw new Error("bindAll must be passed function names");for(t=1;r>t;t++)e=arguments[t],n[e]=m.bind(n[e],n);return n},m.memoize=function(n,t){var e=function(r){var i=e.cache,a=""+(t?t.apply(this,arguments):r);return m.has(i,a)||(i[a]=n.apply(this,arguments)),i[a]};return e.cache={},e},m.delay=function(n,t){var e=c.call(arguments,2);return setTimeout(function(){return n.apply(null,e)},t)},m.defer=m.partial(m.delay,m,1),m.throttle=function(n,t,e){var r,i,a,o=null,u=0;e||(e={});var l=function(){u=e.leading===!1?0:m.now(),o=null,a=n.apply(r,i),o||(r=i=null)};return function(){var c=m.now();u||e.leading!==!1||(u=c);var s=t-(c-u);return r=this,i=arguments,0>=s||s>t?(o&&(clearTimeout(o),o=null),u=c,a=n.apply(r,i),o||(r=i=null)):o||e.trailing===!1||(o=setTimeout(l,s)),a}},m.debounce=function(n,t,e){var r,i,a,o,u,l=function(){var c=m.now()-o;t>c&&c>=0?r=setTimeout(l,t-c):(r=null,e||(u=n.apply(a,i),r||(a=i=null)))};return function(){a=this,i=arguments,o=m.now();var c=e&&!r;return r||(r=setTimeout(l,t)),c&&(u=n.apply(a,i),a=i=null),u}},m.wrap=function(n,t){return m.partial(t,n)},m.negate=function(n){return function(){return!n.apply(this,arguments)}},m.compose=function(){var n=arguments,t=n.length-1;return function(){for(var e=t,r=n[t].apply(this,arguments);e--;)r=n[e].call(this,r);return r}},m.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},m.before=function(n,t){var e;return function(){return--n>0&&(e=t.apply(this,arguments)),1>=n&&(t=null),e}},m.once=m.partial(m.before,2);var S=!{toString:null}.propertyIsEnumerable("toString"),I=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];m.keys=function(n){if(!m.isObject(n))return[];if(p)return p(n);var t=[];for(var r in n)m.has(n,r)&&t.push(r);return S&&e(n,t),t},m.allKeys=function(n){if(!m.isObject(n))return[];var t=[];for(var r in n)t.push(r);return S&&e(n,t),t},m.values=function(n){for(var t=m.keys(n),e=t.length,r=Array(e),i=0;e>i;i++)r[i]=n[t[i]];return r},m.mapObject=function(n,t,e){t=w(t,e);for(var r,i=m.keys(n),a=i.length,o={},u=0;a>u;u++)r=i[u],o[r]=t(n[r],r,n);return o},m.pairs=function(n){for(var t=m.keys(n),e=t.length,r=Array(e),i=0;e>i;i++)r[i]=[t[i],n[t[i]]];return r},m.invert=function(n){for(var t={},e=m.keys(n),r=0,i=e.length;i>r;r++)t[n[e[r]]]=e[r];return t},m.functions=m.methods=function(n){var t=[];for(var e in n)m.isFunction(n[e])&&t.push(e);return t.sort()},m.extend=x(m.allKeys),m.extendOwn=m.assign=x(m.keys),m.findKey=function(n,t,e){t=w(t,e);for(var r,i=m.keys(n),a=0,o=i.length;o>a;a++)if(r=i[a],t(n[r],r,n))return r},m.pick=function(n,t,e){var r,i,a={},o=n;if(null==o)return a;m.isFunction(t)?(i=m.allKeys(o),r=y(t,e)):(i=O(arguments,!1,!1,1),r=function(n,t,e){return t in e},o=Object(o));for(var u=0,l=i.length;l>u;u++){var c=i[u],s=o[c];r(s,c,o)&&(a[c]=s)}return a},m.omit=function(n,t,e){if(m.isFunction(t))t=m.negate(t);else{var r=m.map(O(arguments,!1,!1,1),String);t=function(n,t){return!m.contains(r,t)}}return m.pick(n,t,e)},m.defaults=x(m.allKeys,!0),m.clone=function(n){return m.isObject(n)?m.isArray(n)?n.slice():m.extend({},n):n},m.tap=function(n,t){return t(n),n},m.isMatch=function(n,t){var e=m.keys(t),r=e.length;if(null==n)return!r;for(var i=Object(n),a=0;r>a;a++){var o=e[a];if(t[o]!==i[o]||!(o in i))return!1}return!0};var E=function(n,t,e,r){if(n===t)return 0!==n||1/n===1/t;if(null==n||null==t)return n===t;n instanceof m&&(n=n._wrapped),t instanceof m&&(t=t._wrapped);var i=s.call(n);if(i!==s.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+n==""+t;case"[object Number]":return+n!==+n?+t!==+t:0===+n?1/+n===1/t:+n===+t;case"[object Date]":case"[object Boolean]":return+n===+t}var a="[object Array]"===i;if(!a){if("object"!=typeof n||"object"!=typeof t)return!1;var o=n.constructor,u=t.constructor;if(o!==u&&!(m.isFunction(o)&&o instanceof o&&m.isFunction(u)&&u instanceof u)&&"constructor"in n&&"constructor"in t)return!1}e=e||[],r=r||[];for(var l=e.length;l--;)if(e[l]===n)return r[l]===t;if(e.push(n),r.push(t),a){if(l=n.length,l!==t.length)return!1;for(;l--;)if(!E(n[l],t[l],e,r))return!1}else{var c,f=m.keys(n);if(l=f.length,m.keys(t).length!==l)return!1;for(;l--;)if(c=f[l],!m.has(t,c)||!E(n[c],t[c],e,r))return!1}return e.pop(),r.pop(),!0};m.isEqual=function(n,t){return E(n,t)},m.isEmpty=function(n){return null==n?!0:k(n)&&(m.isArray(n)||m.isString(n)||m.isArguments(n))?0===n.length:0===m.keys(n).length},m.isElement=function(n){return!(!n||1!==n.nodeType)},m.isArray=h||function(n){return"[object Array]"===s.call(n)},m.isObject=function(n){var t=typeof n;return"function"===t||"object"===t&&!!n},m.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(n){m["is"+n]=function(t){return s.call(t)==="[object "+n+"]"}}),m.isArguments(arguments)||(m.isArguments=function(n){return m.has(n,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(m.isFunction=function(n){return"function"==typeof n||!1}),m.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},m.isNaN=function(n){return m.isNumber(n)&&n!==+n},m.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"===s.call(n)},m.isNull=function(n){return null===n},m.isUndefined=function(n){return void 0===n},m.has=function(n,t){return null!=n&&f.call(n,t)},m.noConflict=function(){return r._=i,this},m.identity=function(n){return n},m.constant=function(n){return function(){return n}},m.noop=function(){},m.property=function(n){return function(t){return null==t?void 0:t[n]}},m.propertyOf=function(n){return null==n?function(){}:function(t){return n[t]}},m.matcher=m.matches=function(n){return n=m.extendOwn({},n),function(t){return m.isMatch(t,n)}},m.times=function(n,t,e){var r=Array(Math.max(0,n));t=y(t,e,1);for(var i=0;n>i;i++)r[i]=t(i);return r},m.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},m.now=Date.now||function(){return(new Date).getTime()};var M={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},F=m.invert(M),C=function(n){var t=function(t){return n[t]},e="(?:"+m.keys(n).join("|")+")",r=RegExp(e),i=RegExp(e,"g");return function(n){return n=null==n?"":""+n,r.test(n)?n.replace(i,t):n}};m.escape=C(M),m.unescape=C(F),m.result=function(n,t,e){var r=null==n?void 0:n[t];return void 0===r&&(r=e),m.isFunction(r)?r.call(n):r};var R=0;m.uniqueId=function(n){var t=++R+"";return n?n+t:t},m.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var N=/(.)^/,T={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},z=/\\|'|\r|\n|\u2028|\u2029/g,B=function(n){return"\\"+T[n]};m.template=function(n,t,e){!t&&e&&(t=e),t=m.defaults({},t,m.templateSettings);var r=RegExp([(t.escape||N).source,(t.interpolate||N).source,(t.evaluate||N).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(r,function(t,e,r,o,u){return a+=n.slice(i,u).replace(z,B),i=u+t.length,e?a+="'+\n((__t=("+e+"))==null?'':_.escape(__t))+\n'":r?a+="'+\n((__t=("+r+"))==null?'':__t)+\n'":o&&(a+="';\n"+o+"\n__p+='"),t}),a+="';\n",t.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{var o=new Function(t.variable||"obj","_",a)}catch(u){throw u.source=a,u}var l=function(n){return o.call(this,n,m)},c=t.variable||"obj";return l.source="function("+c+"){\n"+a+"}",l},m.chain=function(n){var t=m(n);return t._chain=!0,t};var q=function(n,t){return n._chain?m(t).chain():t};m.mixin=function(n){m.each(m.functions(n),function(t){var e=m[t]=n[t];m.prototype[t]=function(){var n=[this._wrapped];return l.apply(n,arguments),q(this,e.apply(m,n))}})},m.mixin(m),m.each(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=a[n];m.prototype[n]=function(){var e=this._wrapped;return t.apply(e,arguments),"shift"!==n&&"splice"!==n||0!==e.length||delete e[0],q(this,e)}}),m.each(["concat","join","slice"],function(n){var t=a[n];m.prototype[n]=function(){return q(this,t.apply(this._wrapped,arguments))}}),m.prototype.value=function(){return this._wrapped},m.prototype.valueOf=m.prototype.toJSON=m.prototype.value,m.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return m})}).call(this),function(n){function t(t){if("string"!=typeof t)return"";var e="{%[^%}]*%}|%%[^%%]*%%|{{[^}}]*}}",r=new RegExp(e,"gi"),i=new RegExp("^("+e+")","i"),a=(i.test(t),t.match(r)||[]),o=t.split(r),u=(a&&a.length||0,0),l="";return n.each(o,function(n,t){l+=encodeURIComponent(t)+(a[u]?a[u]:""),u++}),l}function e(n){n=n.replace(/(\[|\])/g,"\\$1");var t=new RegExp("[\\?&]"+n+"=([^&#]*)"),e=t.exec(window.location.href);return null===e?"":e[1]}function r(n){var t={};return n&&n.split("#")[0].replace("?","").replace(/\&amp;/gi,"&").replace(/([^=&]+)=([^&]*)/g,function(n,e,r){r=r.replace(/\+/g,"%20"),t[decodeURIComponent(e)]=decodeURIComponent(r)}),t}function i(n){var t=document.createElement("a");return t.href=n,t.pathname=t.pathname.replace(/(^\/?)/,"/"),t}function a(){b.removeClass("loading"),M?b.html('No file found. Either add one to your local /img directory or <a href="'+z+'">Edit the default</a>'):b.load("/upload.php #upload-form-col",function(n,t){"error"===t&&b.html("No image specified. <p><a href='/upload.php'>Please login as an admin to upload an image</a>.")})}function o(t){var e=[{}];return n.each(t,function(n,t){var r,i;-1===n.indexOf("]")?e[0][n]=t:(i=n.split("[")[0],r=n.split("[")[1].replace("]",""),r||(r=e.length),e[r]||(e[r]={}),_.contains(q,i)&&(e[r][i]=t))}),e}function u(t){var e,r;t=_.defaults(t,B),t.color&&-1===t.color.indexOf("#")&&(t.color="#"+t.color),"normal"===t["white-space"]&&v.find('[name="max-width"]').closest(".form-group").toggleClass("dim",!1),e=(t["text-shadow"]&&t["text-shadow"]||"0 0 #000000 0").split(" "),O.find("input").each(function(t,r){3===t&&(e[t]=Math.round(10*(1-Math.round(e[t]/127*10)/10))/10),n(r).val(e[t])}),r=(t.outline&&t.outline||"0 #000000 77").split(" "),S.find("input").each(function(t,e){2===t&&(r[t]=Math.round(10*(1-Math.round(r[t]/127*10)/10))/10),n(e).val(r[t])}),n.each(_.defaults(t,B),function(n,t){v.find('[name="'+n+'"]').val(t),console.log(n,"",t,"=",v.find('[name="'+n+'"]').val())}),t.text&&j.val(t.text)}function l(n,t){return 0===n?'<li role="presentation" data-layer="'+n+'" class="layer-tab'+(t===n?" active":"")+'"><a data-toggle="dropdown" aria-expanded="false">Layer '+(n+1)+"</a></li>":'<li role="presentation" data-layer="'+n+'" class="layer-tab dropdown'+(t===n?" active":"")+'"><a data-toggle="dropdown" aria-expanded="false">Layer '+(n+1)+' <span class="caret"></span></a><ul class="dropdown-menu" role="menu"><li title="Remove this text layer"><a data-delete="'+n+'" class="delete">Delete layer</a></li></ul></li>'}function c(){var t=window.location.href.split("#")[1]||"",e="";return C=o(r(t)),T=C[T]&&T||C.length-1>0&&C.length-1||0,sessionStorage.setItem(R,T),""===t&&(C[0].left=80,C[0].top=80,C[0]["text-align"]=""),d.find(".layer-tab").remove(),n.each(C,function(n){e+=l(n,T)}),d.prepend(e),n("#new-layer").toggle(C.length<7),x.css({height:"auto"}),x.height(x.height()),C}function s(n){var t='<div class="alert alert-warning alert-dismissible fixed-alert" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Warning!</strong> '+n+"</div>";E.append(t)}function f(){c(),u(C[T]),v.on("change",'[name="vertical-align"]',function(){var t=n(this).val(),e=n('[name="top"]'),r=b.find("img").data("height");e.val("middle"===t?r/2:"bottom"===t?r:0)}).on("change",'[name="text-align"]',function(){var t=n(this).val(),e=b.find("img").data("width");"center"===t?n('[name="left"]').val(Math.abs(e/2)):(""===t||"right"===t)&&n('[name="left"]').val(0)}).on("change",'[name="white-space"]',function(){var t=n(this).val();v.find('[name="max-width"]').closest(".form-group").toggleClass("dim","normal"!==t)}).on("change init navigate",function(e){C[T]=n(this).find("[name]").filter(function(t,e){var r=n(e),i=r.attr("name"),a=r.val();return""!==a&&a!==B[i]}).serializeObject(),C=_.map(C,function(n){return _.pick(n,function(n,t){return"local"!==t&&""!==n&&n!==B[t]})});var r=(F.local?"local=1":"")+(1===C.length?"&"+n.param(_.omit(C[0],"text")):_.reduce(C,function(t,e,r){return t+"&"+n.param(_.omit(e,"text")).replace(/\+/g,"%20").replace(/\=/g,"["+r+"]=")},"")),o=r+(1===C.length?"&text="+encodeURIComponent(C[0].text):_.reduce(C,function(n,t,e){return n+("&text="+encodeURIComponent(t.text)).replace(/\=/g,"["+e+"]=")},"")),u=r+(1===C.length?"&text="+t(C[0].text):_.reduce(C,function(n,e,r){return n+("&text="+t(e.text)).replace(/\=/g,"["+r+"]=")},"")),l=F.img+"?"+u,c=_.now(),f=new Image;E.empty(),b.addClass("loading"),f.onerror=a,f.onload=function(){var t=(n(f),{height:f.height,width:f.width,generated_in:_.now()-c+"ms",url_character_length:f.src.length});b.removeClass("loading").html(f),n(f).data(t).attr({alt:p,title:"Click to position the text layer absolutely"}),k.html(JSON.stringify(t,void 0,1)),t.height>=1700&&s("Images longer than 1700 pixels are not recommended, as they may break in older email clients. Consider breaking your image into multiple images.")},f.src=l,m.val(i(l).href.split("?")[0]+"?"+u),y.attr("href",f.src).css({visibility:"visible",opacity:1}),f.src&&f.src.length>=2118?s("The url string you've created is longer than 2117 characters which exceeds what Google App Engine will allow (the image preview is very likely broken).  Consider breaking your image into multiple images."):f.src&&f.src.length>=1900&&s("The url string you've created is longer than 1900 characters which may start to break in older email clients. Consider breaking your image into multiple images."),p++,"navigate"!==e.type&&history.pushState({id:p,layers:C.length},p,window.location.href.split("#")[0]+"#"+o)}).trigger("init"),j.on("keyup",function(){var n=p;clearTimeout(h),h=setTimeout(function(){p===n&&j.trigger("change")},800)}),m.on("focus",function(){var t=n(this);window.setTimeout(function(){t.select()},20)}),b.on("click","img",function(t){var e=n(this).offset(),r=b.find("img"),i={width:r.width(),height:r.height()},a=r.data(),o=t.pageX-e.left,u=t.pageY-e.top,l=v.find('[name="text-align"]').val();i.width!==a.width&&(o*=a.width/i.width),i.height!==a.height&&(u*=a.height/i.height),"right"===l&&(o=a.width-o),v.find('[name="left"]').val(Math.round(o)).end().find('[name="top"]').val(Math.round(u)).trigger("change")}),O.on("change",function(){var t=O.find("input").map(function(){var t=n(this);return t.is("#ts-alpha")?127-~~(127*t.val()):t.val()}).get().join(" ");A.val("0"===n("#ts-left").val()&&"0"===n("#ts-top").val()||"0"===n("#ts-alpha").val()?"":t),v.trigger("change")}),S.on("change",function(){var t=S.find("input").map(function(){var t=n(this);return t.is("#to-alpha")?127-~~(127*t.val()):t.val()}).get().join(" ");I.val("0"===n("#to-spread").val()||"0"===n("#to-alpha").val()?"":t),v.trigger("change")}),d.on("click","[data-layer]",function(){d.find(".active").removeClass("active");var t=n(this).addClass("active");T=parseFloat(t.data("layer")),sessionStorage.setItem(R,T),u(C[T])}),g.on("click","#new-layer",function(){var t,e=_.clone(C[T]),r=n.extend(!0,e||{},{left:parseFloat(e.left||0)+5,top:parseFloat(e.top||0)+5});C.push(_.pick(r,_.keys(B))),T=C.length-1,t=n(l(T)),n(this).before(t),t.click(),8===C.length&&n("#new-layer").hide(),v.trigger("change")}).on("click","#reset",function(){var n=confirm("Are you sure you want to start from scratch?");n&&(window.location=location.href.split("#")[0])}).on("click","[data-delete]",function(){var t=n(this),e=t.data("delete");e===T&&(T-=1),C.splice(t.data("delete"),1),d.find(".layer-tab").eq(T).click(),v.trigger("change"),c()}).on("click",".clearer",function(){n(this).prevAll("input").each(function(){var t=n(this),e=t.attr("name");e in B?t.val("top"===e&&C[T]["vertical-align"]&&""!==C[T]["vertical-align"]?b.find("img").data("height")/("bottom"===C[T]["vertical-align"]?1:2):"left"===e&&C[T]["text-align"]&&"center"===C[T]["text-align"]?Math.round(b.find("img").data("width")/2):B[e]):e in D&&t.val(D[e])}),n(this).prev("input").trigger("change")}),x.on("mousemove","textarea",_.debounce(function(){x.css({height:"auto"}),x.height(x.height())},50)),n(window).on("hashchange",function(){c(),T=0,u(C[0]),v.trigger("navigate")}),x.addClass("loaded")}n.fn.serializeObject=function(){var t={},e=this.serializeArray();return n.each(e,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t};var h,p=0,g=n("body"),d=g.find("#layers"),v=g.find("form"),m=g.find("#output"),y=g.find("#output-link"),w=g.find("#font-family"),x=g.find("#control-section"),b=g.find("#preview"),k=g.find("#data"),j=g.find("#text"),O=g.find(".ts-fields"),A=g.find('[name="text-shadow"]'),S=g.find(".to-fields"),I=g.find('[name="outline"]'),E=g.find(".alert-zone"),M="true"===e("local"),F=r(location.search.replace("?","")),C=(F.img&&F.img.split(".")[1],[]),R="last-edited-layer-"+F.img,N=sessionStorage&&parseInt(sessionStorage.getItem(R),10),T=N||0,z="/edit.html?local=true&img=BSD-logo.png",B={"text-align":"","vertical-align":"",color:"#000000","font-size":"24","letter-spacing":"",top:"0",left:"0","text-transform":"","font-family":"OpenSans-Regular","line-height":"1.5",angle:"0","white-space":"","max-width":"0","text-shadow":"",outline:""},q=_.keys(B).concat(["text"]),D={"ts-left":0,"ts-top":0,"ts-color":"#000000","ts-opacity":1,"to-spread":0,"to-color":"#000000","to-opacity":.4},K=n.ajax({url:"/ajax/fonts.json"});"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname||F.img||(window.location=z),console.log(q),window.warn=s,K.done(function(t){var e="";n.each(t,function(n,t){e+='<option value="'+t+'"'+("OpenSans-Regular"===t?"selected":"")+">"+t+"</option>"}),w.html(e)},f)}(jQuery);